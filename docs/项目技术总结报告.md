# 📚 Stack Overflow 文本聚类项目技术总结报告

## 1. 🎯 项目概述与数据准备

本项目旨在对 **152,758 条**关于 `oracle-database` 的 Stack Overflow 问题进行高精度**语义聚类**，以实现潜在的**去重**目标。整个实验流程遵循标准的数据科学工作流：向量化 → 降维 → 聚类模型选型 → 多维度评估。

### 1.1 语义向量化

- **输入数据：** 152,758 条原始问答文本（包含标题和正文）。

- **预处理：** 清除 HTML 标签、特殊字符、评分、大片代码块和多余空白行等无关内容。

- **编码模型：** 采用 **SBERT 模型** (`all-MiniLM-L6-v2`) 进行语义编码。

- **核心产出：** `oracle_full_content_embeddings.npy`，包含 152,758 个 **384 维**的 L2 归一化语义向量。

---

## 2. 📉 降维与空间结构分析

为了减少计算复杂性、去除高维噪声，并为聚类算法提供最优输入，本阶段实施了 **PCA 降维**。

项目中使用的两个核心脚本及其功能：

- `run_dim_reduction.py`

  - **功能**：执行基础 PCA 降维任务，并将原始高维数据通过 UMAP 投影到 2D 平面。

  - **关键输出**：生成了所有的 `.npy` 数据文件和一张基础 2D 可视化图。

- `run_comparison_viz.py`

  - **功能**：执行高级对比任务。循环读取 50/100/256 维的 PCA 数据，分别计算 t-SNE 和 3D UMAP。

  - **关键输出**：生成了用于评估不同维度效果的对比图集（HTML 和 PNG）。

### 2.1 PCA 降维选型

通过对比不同目标维度下的方差解释率，确定了降维目标。

| **目标维度** | **方差解释率 (信息保留率)** | **结论**                                   |
| :----------- | :-------------------------- | :----------------------------------------- |
| **256 维**   | **97.68%**                  | **最终输入**，最大程度保留了原始语义信息。 |
| 100 维       | 77.1%                       | 信息保留率不足，不适用于高精度去重。       |
| 50 维        | 60.52%                      | 语义细节大量丢失。                         |

**最终输入：** `pca_256.npy`（256 维 PCA 降维后的语义向量）。

### 2.2 数据分布观察

通过 **UMAP/t-SNE** 可视化分析，观察到数据的空间分布呈**非球形、多核心团簇 (Multi-Core Clusters)** 结构。这种分布特征暗示了数据中存在多个高密度区域，最初倾向于**密度聚类（DBSCAN）**。

---

## 3. ⚙️ 聚类模型选型与优化

本阶段对比了 DBSCAN 和 MiniBatchKMeans 两种主流聚类算法，最终选定 **K-Means (K\=1180)** 模型。

### 3.1 DBSCAN 失败分析

在 256 维高维连续分布空间中，DBSCAN 难以找到明确的密度边界。

- **实验范围：** eps∈\[0.3, 1.5]，min_samples ∈ \[3, 10]。

- **最佳结果：** Grid Search 最佳参数为 eps\=0.9, min_samples\=5。

- **评估指标：** 最佳 Silhouette Score 仅为 **-0.0407**。

- **结论：** **DBSCAN 不适用**。高维空间中距离差异小，密度分布均匀，**K-Distance 曲线无明显“膝点” (Knee Point)**，无法进行有效划分。

#### 网格搜索详细数据 (Grid Search Metrics)

| Eps ($eps$) | Min Samples | Clusters | Noise Ratio | Silhouette Score | 状态/评价                |
| :---------- | :---------- | :------- | :---------- | :--------------- | :----------------------- |
| **0.5**     | 3           | 7        | 6.53%       | -0.1043          | 效果差                   |
| 0.5         | 5 / 10      | 0        | 6.55%       | N/A              | **忽略** (无簇)          |
| **0.6**     | 3           | 45       | 6.34%       | -0.1854          | 轮廓系数低               |
| 0.6         | 5           | 8        | 6.46%       | -0.1127          | -                        |
| **0.7**     | 3           | 142      | 5.56%       | -0.2128          | -                        |
| 0.7         | 10          | 6        | 6.22%       | -0.0917          | -                        |
| **0.8**     | 3           | 112      | 3.65%       | -0.1885          | -                        |
| 0.8         | 5           | 52       | 4.21%       | -0.1584          | -                        |
| **0.85**    | 3           | 72       | 2.48%       | -0.1593          | -                        |
| **0.9**     | **5**       | **6**    | **1.62%**   | **-0.0407**      | **Grid Search 最佳参数** |
| 0.95        | 3           | 10       | 0.55%       | -0.0807          | -                        |
| 1.0+        | Any         | < 2      | < 0.2%      | N/A              | **忽略** (合并为单一簇)  |

### 3.2 K-Means (K\=1180) 优化与选定

采用 **Davies-Bouldin Index (DBI)** 结合 Elbow 法则对 MiniBatchKMeans 进行 K 值搜索。

#### 关键 K 值指标变化表 (DBI 越低越好)

| K 值     | DBI Score (↓) | Inertia   | 备注                         |
| :------- | :------------ | :-------- | :--------------------------- |
| 20       | 4.2614        | 123657    | 起始点，误差大               |
| 100      | 4.0917        | 109631    | -                            |
| 300      | 4.1544        | 101590    | -                            |
| 500      | 4.0468        | 98147     | -                            |
| 800      | 3.8897        | 95178     | 指标开始显著优化             |
| 1000     | 3.7491        | 94035     | 进入最优区间                 |
| 1100     | 3.7099        | 93486     | -                            |
| 1140     | 3.6735        | 93194     | -                            |
| 1160     | 3.7013        | 93054     | -                            |
| **1180** | **3.6190**    | **92946** | **★ 全局最优 (Global Best)** |
| 1200     | 3.6768        | 93062     | 过拟合/指标回弹              |

**最终模型：** **K-Means (K\=1180)**。

**抽样验证：** 对 **Cluster ID 1061**（一个包含 139 个问题的簇）进行语义检查，发现该簇内 **TNS_ADMIN / tnsnames.ora** 等 Oracle 配置问题关键词出现了 88 次，**语义高度一致**，证明模型能有效聚合精细主题。

### 3.3 模型对比与降维可视化

1.  **DBSCAN 缺陷**：

    - 文件 `k_distance_k5_cosine.png` 显示平滑 S 曲线，无拐点，证明数据无明显密度边界。

2.  **K-Means 有效性**：

    - **高维可视化 (1180 类)**：参考 `1180_2d_sample_visualization.png`。由于类别过多且语义相近，UMAP 图视觉上较为拥挤，但数学指标 (DBI) 证明了分类的有效性。

    - **低维验证 (20 类)**：参考 `20_2d_sample_visualization.png`。当强制将 K 设为 20 时，UMAP 图显示出明显的聚类分界。这证明算法本身有效，当前分类较细是因为文本语义本身的复杂性和重叠性。

### 3.4 结论

- **放弃 DBSCAN**：参数敏感且无法适应高维连续分布数据。

- **选定 K-Means (K\=1180)**：虽然类别数量较多，但 DBI 分数最低，且人工抽检（Label 1061）证明簇内语义高度一致，聚类效果超过人工分类水平。

---

## 4. ✅ 模型评估与去重验证

本阶段设计了严谨的**多指标体系**和**六类对照基线**，全面评估了 K-Means 聚类模型的有效性，并进行了定性去重案例分析。

### 4.1 六类对照基线（Baselines）

为了排除“伪聚类”的可能性，检验真实聚类是否捕捉到有效语义结构，设计了六类基线进行对比。

| **Baseline**                | **描述**                                                 | **用途**                                                       |
| :-------------------------- | :------------------------------------------------------- | :------------------------------------------------------------- |
| **Uniform Random**          | 完全随机将样本分配到 K 个簇。                            | 验证真实聚类是否明显优于**随机噪声**。                         |
| **Shuffle True Size**       | 保持真实聚类簇大小分布，但随机打乱样本归属。             | 消除**簇大小分布**对指标的影响，判断结构性是否源于内容。       |
| **Length Buckets**          | 按文本**长度**排序后，均匀切成 K 段。                    | 检验“文本长短”是否主导聚类结构。                               |
| **PCA-1 Buckets**           | 按 **PCA 第一主成分**排序后，均匀切成 K 段。             | 判断聚类是否仅沿着样本主变化方向进行简单切分。                 |
| **Random Centroid Voronoi** | 随机生成 K 个中心点，进行 Voronoi 划分。                 | 模拟**随机空间划分**，观察真实聚类是否显著优于此种无结构划分。 |
| **KMeans++ One-Shot**       | 使用 KMeans++ 初始化中心，**但不进行任何 EM 优化迭代**。 | 衡量 **KMeans 迭代优化**的必要性。                             |

### 4.2 九大聚类指标（Metrics）

为全面衡量聚类质量，使用了覆盖紧致度、分离度、结构性和噪声程度的九项指标。

| **指标**                          | **公式/定义**                                                                                                 | **优化方向**   | **衡量维度**               |
| :-------------------------------- | :------------------------------------------------------------------------------------------------------------ | :------------- | :------------------------- |
| **Silhouette Score**              | \$s(i)\=\frac{b(i)-a(i)}{\max(a(i),b(i))}\$                                                                   | **↑ 越高越好** | 紧致度/分离度              |
| **Davies–Bouldin Index (DBI)**    | \$\text{DBI} \= \frac{1}{K} \sum\_{i\=1}^K \max\_{j\ne i} \left(\frac{\sigma_i+\sigma_j}{d(c_i,c_j)}\right)\$ | **↓ 越低越好** | 分离度 (核心主指标)        |
| **Calinski–Harabasz Index (CHI)** | \$\text{CHI} \= \frac{\text{between-cluster dispersion}}{\text{within-cluster dispersion}}\$                  | **↑ 越高越好** | 结构性 (方差比)            |
| **Dunn Index**                    | \$D \= \frac{\min\limits\_{i\ne j} d(c_i,c_j)}{\max\limits\_{k} \text{diameter}(cluster_k)}\$                 | **↑ 越高越好** | 结构性 (最小间距/最大直径) |
| **Cohesion**                      | 簇内样本平均距离                                                                                              | **↓ 越低越好** | 紧致度                     |
| **Separation**                    | 簇中心平均距离                                                                                                | **↑ 越高越好** | 分离度                     |
| **Cosine Intra Similarity**       | 簇内样本与簇中心余弦相似度                                                                                    | **↑ 越高越好** | 紧致度                     |
| **Cosine Inter Similarity**       | 簇中心之间的余弦相似度                                                                                        | **↓ 越低越好** | 分离度                     |
| **Singleton Ratio**               | \$\frac{\\#{cluster\ size \= 1}}{K}\$                                                                         | **↓ 越低越好** | 噪声程度 (碎片化)          |

### 4.3 量化评估结果（\$K\=20\$ 与 \$K\=1180\$ 对比）

所有聚类方案（K\=20, 100, 250, 500, 1180, 2000）均进行了全面指标计算。以下展示对比结果。

K \= 20、100 、250、500、1180、2000 的数据对比如下：

| Variant           | Sil ↑      | DBI ↓      | CHI ↑       | Dunn ↑     | Coh ↓      | Sep ↑      | CosIntra ↑ | CosInter ↓  | Single ↓  |
| ----------------- | ---------- | ---------- | ----------- | ---------- | ---------- | ---------- | ---------- | ----------- | --------- |
| **kmeans**        | **0.0307** | **4.2614** | **1897.61** | **0.2156** | **1.2646** | **0.6171** | **0.4335** | **-0.0444** | **0.000** |
| uniform_random    | -0.0090    | 141.18     | 0.99        | 0.0078     | 1.4110     | 0.0161     | 0.0162     | 0.5074      | 0.000     |
| shuffle_size      | -0.0103    | 142.85     | 1.01        | 0.0076     | 1.4110     | 0.0163     | 0.0162     | 0.4853      | 0.000     |
| length_buckets    | -0.0106    | 95.05      | 37.71       | 0.0079     | 1.4077     | 0.0811     | 0.0575     | 0.1120      | 0.000     |
| pca1_buckets      | -0.0126    | 29.72      | 790.54      | 0.0294     | 1.3446     | 0.3745     | 0.2710     | 0.0044      | 0.000     |
| random_centroid   | -0.0101    | 7.52       | 484.86      | 0.1421     | 1.3679     | 0.3361     | 0.2369     | -0.0468     | 0.000     |
| kmeanspp_one_shot | 0.0104     | 5.63       | 1429.13     | 0.1548     | 1.2946     | 0.5458     | 0.3858     | -0.0422     | 0.000     |

| Variant           | Sil ↑      | DBI ↓      | CHI ↑      | Dunn ↑     | Coh ↓      | Sep ↑      | CosIntra ↑ | CosInter ↓  | Single ↓  |
| ----------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ----------- | --------- |
| **kmeans**        | **0.0238** | **4.0917** | **609.86** | **0.1854** | **1.1899** | **0.7469** | **0.5295** | **-0.0049** | **0.000** |
| uniform_random    | -0.0300    | 66.41      | 1.01       | 0.0157     | 1.4103     | 0.0362     | 0.0281     | 0.1642      | 0.000     |
| shuffle_size      | -0.0357    | 70.12      | 0.99       | 0.0114     | 1.4104     | 0.0377     | 0.0275     | 0.1604      | 0.000     |
| length_buckets    | -0.0316    | 59.10      | 8.54       | 0.0162     | 1.4068     | 0.0888     | 0.0636     | 0.0987      | 0.000     |
| pca1_buckets      | -0.0351    | 51.74      | 154.20     | 0.0168     | 1.3429     | 0.3640     | 0.2727     | 0.0434      | 0.000     |
| random_centroid   | -0.0301    | 6.67       | 158.26     | 0.1520     | 1.3384     | 0.4179     | 0.3027     | -0.0072     | 0.000     |
| kmeanspp_one_shot | 0.0064     | 4.88       | 486.04     | 0.1525     | 1.2211     | 0.6795     | 0.4874     | -0.0056     | 0.000     |

| Variant           | Sil ↑      | DBI ↓      | CHI ↑      | Dunn ↑     | Coh ↓      | Sep ↑      | CosIntra ↑ | CosInter ↓  | Single ↓  |
| ----------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ----------- | --------- |
| **kmeans**        | **0.0167** | **4.1192** | **298.55** | **0.1780** | **1.1489** | **0.7972** | **0.5695** | **-0.0017** | **0.000** |
| uniform_random    | -0.0645    | 43.07      | 0.99       | 0.0243     | 1.4089     | 0.0566     | 0.0416     | 0.0738      | 0.000     |
| shuffle_size      | -0.0751    | 44.16      | 1.01       | 0.0197     | 1.4091     | 0.0601     | 0.0417     | 0.0691      | 0.000     |
| length_buckets    | -0.0669    | 39.69      | 4.04       | 0.0249     | 1.4053     | 0.1017     | 0.0723     | 0.0622      | 0.000     |
| pca1_buckets      | -0.0618    | 37.66      | 61.95      | 0.0252     | 1.3417     | 0.3668     | 0.2748     | 0.0464      | 0.000     |
| random_centroid   | -0.0603    | 6.06       | 91.17      | 0.1527     | 1.3060     | 0.4818     | 0.3571     | -0.0008     | 0.000     |
| kmeanspp_one_shot | -0.0038    | 4.72       | 245.12     | 0.1335     | 1.1838     | 0.7408     | 0.5325     | -0.0008     | 0.000     |

| Variant           | Sil ↑      | DBI ↓      | CHI ↑      | Dunn ↑     | Coh ↓      | Sep ↑      | CosIntra ↑ | CosInter ↓  | Single ↓  |
| ----------------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ----------- | --------- |
| **kmeans**        | **0.0024** | **4.0468** | **170.83** | **0.1663** | **1.1207** | **0.8373** | **0.5964** | **-0.0005** | **0.002** |
| uniform_random    | -0.1278    | 30.75      | 1.00       | 0.0340     | 1.4066     | 0.0806     | 0.0580     | 0.0373      | 0.000     |
| shuffle_size      | -0.1519    | 31.90      | 1.00       | 0.0280     | 1.4071     | 0.0899     | 0.0572     | 0.0355      | 0.002     |
| length_buckets    | -0.1212    | 29.15      | 2.51       | 0.0349     | 1.4030     | 0.1182     | 0.0837     | 0.0386      | 0.000     |
| pca1_buckets      | -0.1061    | 27.75      | 31.41      | 0.0299     | 1.3383     | 0.3715     | 0.2780     | 0.0450      | 0.000     |
| random_centroid   | -0.1092    | 5.74       | 51.51      | 0.1326     | 1.2931     | 0.5134     | 0.3766     | 0.0003      | 0.000     |
| kmeanspp_one_shot | -0.0212    | 4.61       | 143.71     | 0.1236     | 1.1529     | 0.7856     | 0.5638     | -0.0001     | 0.000     |

| Variant           | Sil ↑       | DBI ↓      | CHI ↑     | Dunn ↑     | Coh ↓      | Sep ↑      | CosIntra ↑ | CosInter ↓ | Single ↓   |
| ----------------- | ----------- | ---------- | --------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
| **kmeans**        | **-0.0187** | **3.6190** | **83.37** | **0.1537** | **1.0861** | **0.9262** | **0.6247** | **0.0008** | **0.0712** |
| uniform_random    | -0.2140     | 20.45      | 0.99      | 0.0496     | 1.4004     | 0.1239     | 0.0879     | 0.0167     | 0.000      |
| shuffle_size      | -0.2102     | 20.17      | 1.00      | 0.0339     | 1.4031     | 0.2785     | 0.0825     | 0.0133     | 0.0712     |
| length_buckets    | -0.2138     | 19.57      | 1.65      | 0.0497     | 1.3969     | 0.1533     | 0.1083     | 0.0178     | 0.000      |
| pca1_buckets      | -0.1809     | 18.82      | 13.87     | 0.0400     | 1.3270     | 0.3856     | 0.2867     | 0.0381     | 0.000      |
| random_centroid   | -0.1454     | 5.27       | 27.04     | 0.1530     | 1.2633     | 0.5640     | 0.4136     | 0.0022     | 0.000      |
| kmeanspp_one_shot | -0.0489     | 4.41       | 72.67     | 0.1432     | 1.1138     | 0.8354     | 0.5990     | 0.0012     | 0.000      |

| Variant           | Sil ↑       | DBI ↓      | CHI ↑     | Dunn ↑     | Coh ↓      | Sep ↑      | CosIntra ↑ | CosInter ↓ | Single ↓  |
| ----------------- | ----------- | ---------- | --------- | ---------- | ---------- | ---------- | ---------- | ---------- | --------- |
| **kmeans**        | **-0.0249** | **3.1489** | **52.50** | **0.1812** | **1.0721** | **1.0227** | **0.6379** | **0.0005** | **0.187** |
| uniform_random    | -0.2068     | 15.82      | 0.99      | 0.0606     | 1.3929     | 0.1621     | 0.1144     | 0.0095     | 0.000     |
| shuffle_size      | -0.2149     | 14.48      | 1.00      | 0.0362     | 1.4003     | 0.5080     | 0.0997     | 0.0071     | 0.187     |
| length_buckets    | -0.2017     | 15.42      | 1.38      | 0.0605     | 1.3900     | 0.1857     | 0.1311     | 0.0106     | 0.000     |
| pca1_buckets      | -0.1764     | 14.67      | 8.60      | 0.0490     | 1.3082     | 0.4014     | 0.2967     | 0.0315     | 0.000     |
| random_centroid   | -0.1403     | 4.93       | 18.15     | 0.1498     | 1.2368     | 0.5996     | 0.4372     | 0.0033     | 0.000     |
| kmeanspp_one_shot | -0.0485     | 4.20       | 47.69     | 0.1415     | 1.0878     | 0.8675     | 0.6206     | 0.0012     | 0.000     |

**结论：** 在 K\=1180 下，KMeans 是指标最优，各 Baseline 全面崩溃。虽然 Silhouette Score 较低，但这是**高分辨率、稀疏语义聚类**的常见特征。**DBI (3.6190) 达到全局最低点**，证明该簇数量下结构最可分。

### 4.4 定性去重案例分析（Cluster 816）

对 K\=1180 簇中的 question_id\=308（“数据库结构变更的版本控制”）所属的 **Cluster 816** 进行二级子主题分析，以验证语义聚合的去重效果。

#### **真实聚类 (KMeans Cluster 816) 结构**

该簇被分解为五个高度内聚的子主题，语义围绕 “Oracle schema versioning & migration” 的核心主题展开。

| **Cluster 816 子主题** | **核心语义内容**                                                                            |
| :--------------------- | :------------------------------------------------------------------------------------------ |
| **Subtopic 0**         | Schema Migration / Archive / Script 自动化，涉及 schema 升级、归档策略。                    |
| **Subtopic 1**         | PL/SQL 开发与代码版本管理，聚焦 Oracle package 开发流程、多人协作。                         |
| **Subtopic 2**         | DDL 变更监控 / APEX / Trigger 相关机制，涵盖 Oracle DDL tracking、schema change detection。 |
| **Subtopic 3**         | Migration Script 生成、自动化构建、版本差异生成，直接涉及如何自动生成脚本。                 |
| **Subtopic 4**         | Version Control 理论、对象导出、schema diff 工具，完美对应原问题的语义中心。                |

**结论：** 簇 816 形成了**主题高度聚合、层级分明、语义连贯**的知识图谱，证明模型能高效识别“本质上相同但表达不同”的重复问题，去重效果优异。

#### **Baseline 定性失败分析**

- **Baseline: KMeans++ One-Shot** (Cluster 1043)：主题方向偏移到\*\*“实时变更通知”\*\* (ODP.NET change notification) 而非 “schema versioning”，结构开始变形。

- **Baseline: Length Buckets** (Cluster 1038)：主题退化为 **“Oracle general Q\&A” 杂集**，出现 PL/SQL 基础语法、shell 脚本调用等，与 versioning 几乎无关。

- **Baseline: PCA1 Buckets** (Cluster 897)：出现 **“view/query/insert/index/procedure/error”大杂烩**，Version control 主题被淹没。

- **Baseline: Random Centroid Voronoi** (Cluster 856)：主题被切成 **“sqlldr error / NVARCHAR / ORA-00904 / data load”** 等不相关小类，完全无法维持语义主题。

- **Baseline: Shuffle Size / Uniform Random**：仅保留随机噪声组合，无任何主题性。

---

## 5. 最终结论与成果交付

### 5.1 最终模型

- **模型：** MiniBatchKMeans

- **输入：** `pca_256.npy` (256 维 PCA 向量)

- **簇数量：** K\=1180

- **评估结论：** 该模型在 DBI 上表现最优，且在定性分析中表现出卓越的语义聚合能力，是实现 Stack Overflow 问题去重的最佳方案。

### 5.2 文件表

| **文件名/类型**                               | **阶段** | **说明**                                                           |
| :-------------------------------------------- | :------- | :----------------------------------------------------------------- |
| `oracle_full_content_embeddings.npy`          | 1        | SBERT 生成的 384 维原始语义向量。                                  |
| `pca_256.npy`                                 | 2        | 用于聚类的 256 维降维向量 (97.7% 信息保留)。                       |
| `1180_final_cluster_labels.csv`               | 3        | 最终聚类标签文件，包含每个问题的 `question_id` 及其 `cluster_id`。 |
| `cluster_metrics_extended_with_baselines.csv` | 4        | 所有 \$K\$ 值下，KMeans 与六类 Baselines 的九项指标全量数据。      |
| `q_308.md`                                    | 4        | Cluster 816 的去重定性分析案例报告。                               |
